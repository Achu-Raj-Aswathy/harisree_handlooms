<%- include('./partials/header') %>



     <!-- START Wrapper -->
     <div class="wrapper">
          <%- include('./partials/adminHeader') %>
               <%- include('./partials/sidebar')%>

                    <!-- ==================================================== -->
                    <!-- Start right Content here -->
                    <!-- ==================================================== -->
                    <div class="page-content">

                         <!-- Start Container Fluid -->
                         <div class="container-xxl">

                              <div class="row">
                                   <div class="col-xl-12">
                                        <div class="card">
                                             <div
                                                  class="card-header d-flex justify-content-between align-items-center gap-1">
                                                  <h4 class="card-title flex-grow-1">All Categories List</h4>

                                                  <a href="/admin/add-category" class="btn btn-sm btn-primary">
                                                       Add Category
                                                  </a>

                                                  <a href="#" class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#exportModal">
                                                       Export
                                                  </a>
                                             </div>
                                             <div>
                                                  <div class="table-responsive">
                                                       <table
                                                            class="table align-middle mb-0 table-hover table-centered">
                                                            <thead class="bg-light-subtle">
                                                                 <tr>

                                                                      <th>ID</th>
                                                                      <th>Category Name</th>
                                                                      <th>Description</th>

                                                                      <th>Action</th>
                                                                 </tr>
                                                            </thead>
                                                            <tbody>
                                                                 <% if(categories.length>0){ %>
                                                                      <% categories.forEach((category)=> { %>
                                                                           <tr data-created="<%= new Date(category.createdAt).toISOString() %>">
                                                                                <td>
                                                                                     <div
                                                                                          class="d-flex align-items-center gap-2">
                                                                                          <div
                                                                                               class="rounded bg-light avatar-md d-flex align-items-center justify-content-center">

                                                                                               <% if (category.images &&
                                                                                                    category.images.length>
                                                                                                    0) { %>

                                                                                                    <img src="<%= category.images[0] %>"
                                                                                                         alt="Category Image"
                                                                                                         class="avatar-md">
                                                                                                    <% } else { %>
                                                                                                         <img src="assets/images/handlooms/sarees27.jpg"
                                                                                                              alt="Category Image"
                                                                                                              class="avatar-md" />
                                                                                                         <% } %>
                                                                                          </div>

                                                                                          <p
                                                                                               class="text-dark fw-medium fs-15 mb-0">
                                                                                               <%= category.categoryId
                                                                                                    %>
                                                                                          </p>
                                                                                     </div>
                                                                                </td>

                                                                                <td>
                                                                                     <%= category.name %>
                                                                                </td>
                                                                                <td>
                                                                                     <%= category.description %>
                                                                                </td>


                                                                                <td>
                                                                                     <div class="d-flex gap-2">
                                                                                          <!-- <a href="#!"
                                                                                               class="btn btn-light btn-sm"><iconify-icon
                                                                                                    icon="solar:eye-broken"
                                                                                                    class="align-middle fs-18"></iconify-icon></a> -->
                                                                                          <a href="/admin/edit-category?id=<%= category._id %> "
                                                                                               class="btn btn-soft-primary btn-sm"><iconify-icon
                                                                                                    icon="solar:pen-2-broken"
                                                                                                    class="align-middle fs-18"></iconify-icon></a>
                                                                                          <a href="#!"
                                                                                               class="btn btn-soft-danger btn-sm delete-category-btn"
                                                                                               data-id="<%= category._id %>">
                                                                                               <iconify-icon
                                                                                                    icon="solar:trash-bin-minimalistic-2-broken"
                                                                                                    class="align-middle fs-18"></iconify-icon>
                                                                                          </a>

                                                                                     </div>
                                                                                </td>
                                                                           </tr>
                                                                           <% }) %>
                                                                                <% } else { %>
                                                                                     <tr>
                                                                                          <td colspan="4"
                                                                                               class="text-center">No
                                                                                               Categories found</td>
                                                                                     </tr>

                                                                                     <% } %>

                                                            </tbody>
                                                       </table>
                                                  </div>
                                                  <!-- end table-responsive -->
                                             </div>
                                             <div class="card-footer border-top">
                                                  <nav aria-label="Page navigation example">
                                                       <ul class="pagination justify-content-end mb-0">
                                                            <% if (currentPage> 1) { %>
                                                                 <li class="page-item">
                                                                      <a class="page-link"
                                                                           href="?page=<%= currentPage - 1 %>">Previous</a>
                                                                 </li>
                                                                 <% } else { %>
                                                                      <li class="page-item disabled">
                                                                           <span class="page-link">Previous</span>
                                                                      </li>
                                                                      <% } %>

                                                                           <% for (let i=1; i <=totalPages; i++) { %>
                                                                                <li
                                                                                     class="page-item <%= currentPage === i ? 'active' : '' %>">
                                                                                     <a class="page-link"
                                                                                          href="?page=<%= i %>">
                                                                                          <%= i %>
                                                                                     </a>
                                                                                </li>
                                                                                <% } %>

                                                                                     <% if (currentPage < totalPages) {
                                                                                          %>
                                                                                          <li class="page-item">
                                                                                               <a class="page-link"
                                                                                                    href="?page=<%= currentPage + 1 %>">Next</a>
                                                                                          </li>
                                                                                          <% } else { %>
                                                                                               <li
                                                                                                    class="page-item disabled">
                                                                                                    <span
                                                                                                         class="page-link">Next</span>
                                                                                               </li>
                                                                                               <% } %>
                                                       </ul>
                                                  </nav>
                                             </div>

                                        </div>
                                   </div>
                              </div>

                         </div>
                         <!-- End Container Fluid -->
                         <%- include('./partials/footer') %>
                    </div>
                    <!-- ==================================================== -->
                    <!-- End Page Content -->
                    <!-- ==================================================== -->
     </div>

    <!-- Include SweetAlert2 CDN (if not already included) -->


<script>
  document.addEventListener("DOMContentLoaded", function () {
    const deleteButtons = document.querySelectorAll(".delete-category-btn");

    deleteButtons.forEach(button => {
      button.addEventListener("click", function () {
        const categoryId = this.dataset.id;

        Swal.fire({
          title: "Are you sure?",
          text: "This will delete the category and its related products!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#3085d6",
          confirmButtonText: "Yes, delete it!"
        }).then((result) => {
          if (result.isConfirmed) {
            fetch(`/admin/delete-category/${categoryId}`, {
              method: "DELETE",
            })
              .then(res => res.json())
              .then(data => {
                if (data.success) {
                  Swal.fire({
                    icon: "success",
                    title: "Deleted!",
                    text: "Category deleted successfully!",
                    showConfirmButton: false,
                    timer: 1500
                  }).then(() => {
                    location.reload(); // Refresh the page
                  });
                } else {
                  Swal.fire("Failed!", "Failed to delete category.", "error");
                }
              })
              .catch(err => {
                console.error("Error:", err);
                Swal.fire("Error!", "An error occurred while deleting.", "error");
              });
          }
        });
      });
    });
  });
</script>


     <!-- Export Date Range Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exportModalLabel">Select Date Range</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="text" class="form-control" id="dateRangeInput" placeholder="dd/mm/yyyy - dd/mm/yyyy" readonly>
        <div class="text-danger mt-2 d-none" id="dateError">Please select a valid date range</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-warning" onclick="downloadCategoryPDF()">Download PDF</button>
      </div>
    </div>
  </div>
</div>

<script>
  let selectedStartDate = null;
  let selectedEndDate = null;

  flatpickr("#dateRangeInput", {
    mode: "range",
    dateFormat: "d/m/Y",
    onChange: function (selectedDates) {
      if (selectedDates.length === 2) {
        selectedStartDate = selectedDates[0];
        selectedEndDate = selectedDates[1];

        if (selectedEndDate < selectedStartDate) {
          document.getElementById('dateError').classList.remove('d-none');
        } else {
          document.getElementById('dateError').classList.add('d-none');
        }
      }
    }
  });
</script>

<script>
async function downloadCategoryPDF() {
  if (!selectedStartDate || !selectedEndDate || selectedEndDate < selectedStartDate) {
    document.getElementById('dateError').classList.remove('d-none');
    return;
  }

  const response = await fetch("/admin/export-categories-pdf", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      startDate: selectedStartDate.toISOString(),
      endDate: selectedEndDate.toISOString(),
    }),
  });

      // ❗ Read the response message if not ok
    if (!response.ok) {
      const errorText = await response.text(); // Get server message
      Swal.fire({
        icon: 'warning',
        title: 'No Results',
        text: errorText || 'Export failed',
      });
      return;
    }

  const blob = await response.blob();
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `categories_${selectedStartDate.toLocaleDateString()}-${selectedEndDate.toLocaleDateString()}.pdf`;
  a.click();

  document.getElementById("dateRangeInput").value = "";
  selectedStartDate = null;
  selectedEndDate = null;
  bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();

  Swal.fire({
    icon: "success",
    title: "Exported!",
    text: "PDF downloaded successfully.",
    showConfirmButton: false,
    timer: 1500
  });
}
</script>


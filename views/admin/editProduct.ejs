 
 <%- include('./partials/header') %>
<%- include('./partials/adminHeader') %>

     <!-- START Wrapper -->
     <div class="wrapper">


<%- include('./partials/sidebar') %>
 

 
          <!-- ========== App Menu End ========== -->

          <!-- ==================================================== -->
          <!-- Start right Content here -->
          <!-- ==================================================== -->
          <div class="page-content">

               <!-- Start Container Fluid -->
               <div class="container-xxl">

                    <div class="row">
                        

                         <div class="col-xl-12 col-lg-12 ">
<form id="editProductForm" enctype="multipart/form-data">
                              <div class="card">
                                   <div class="card-header">
                                        <h4 class="card-title">Edit Product Photo</h4>
                                   </div>
                                    <div class="card-body">
                <input type="file" name="thumbnail[]" class="filepond" multiple
                  data-max-file-size="3MB" data-max-files="5"
                  accept="image/png, image/jpeg, image/gif" />
                <small class="text-muted fs-13 d-block mt-2">
                  1600 x 1200 (4:3) recommended. PNG and JPG files are allowed.
                </small>
              </div>
            </div>
                            
            <div class="card">
              <div class="card-header">
                <h4 class="card-title">Product Information</h4>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-lg-6">
                    <div class="mb-3">
                      <label for="productId" class="form-label">Product ID</label>
                      <input type="text" id="productId" name="productId" class="form-control" disabled
                        value="<%= product.productId %>">
                      <input type="hidden" name="productId" value="<%= product.productId %>">
                    </div>
                  </div>

                  <!-- <div class="col-lg-6">
                    <div class="mb-3">
                      <label for="categoryId" class="form-label">Select Category</label>
                      <select id="categoryId" name="categoryId" class="form-select" required>
                        <option value="">-- Choose a Category --</option>
                        <% categories.forEach(category => { %>
    <option value="<%= category._id %>"><%= category.name %></option>
  <% }) %>
                      </select>
                    </div>
                  </div>
                </div> -->
                <div class="col-lg-6">
  <div class="mb-3">
    <label for="categoryId" class="form-label">Select Category</label>
    <select id="categoryId" name="categoryId" class="form-select" required>
      <option value="">-- Choose a Category --</option>
      <% categories.forEach(category => { %>
        <option 
          value="<%= category._id %>" 
          <%= category._id.toString() === product.categoryId._id.toString() ? 'selected' : '' %>>
          <%= category.name %>
        </option>
      <% }) %>
    </select>
  </div>
</div>

                <div class="row">
                  <div class="col-lg-8">
                    <div class="mb-3">
                      <label for="product-name" class="form-label">Product Name</label>
                      <input type="text" name="productName" id="product-name" class="form-control"
                        value="<%= product.name %>">
                    </div>
                  </div>
                  <div class="col-lg-4">
                    <div class="mb-3">
                      <label for="hsnCode" class="form-label">HSN Code</label>
                      <input type="text" name="hsnCode" id="hsnCode" class="form-control" value="<%= product.hsnCode %>">
                    </div>
                  </div>
                </div>

                <div class="row mb-3">
  <div class="col-lg-4">
    <label for="specification" class="form-label">Blouse Details(if no,type nil)</label>
    <input type="text" name="specification" id="specification" class="form-control" placeholder="Blouse Details" value="<%= product.blouseDetails %>">
  </div>

  <div class="col-lg-4">
    <label for="gender" class="form-label">Gender</label>
    <select class="form-control" name="gender" id="gender">
      <option value="" <%= !product.gender ? 'selected' : '' %>>Select Gender</option>
      <option value="Men" <%= product.gender === 'Men' ? 'selected' : '' %>>Men</option>
      <option value="Women" <%= product.gender === 'Women' ? 'selected' : '' %>>Women</option>
      <option value="Boys" <%= product.gender === 'Boys' ? 'selected' : '' %>>Boys</option>
      <option value="Girls" <%= product.gender === 'Girls' ? 'selected' : '' %>>Girls</option>
      <option value="Unisex" <%= product.gender === 'Unisex' ? 'selected' : '' %>>Unisex</option>
    </select>
  </div>

  <div class="col-lg-4">
    <label for="size" class="form-label">Length</label>
    <input type="text" name="size" id="size" class="form-control" placeholder="Length" value="<%= product.length %>">
  </div>
</div>


                <div class="row">
                  <div class="col-lg-4">
                    <div class="mb-3">
                      <label for="skuId" class="form-label">SKU ID</label>
                      <input type="text" name="skuId" id="skuId" class="form-control" value="<%= product.skuId %>">
                    </div>
                  </div>
                  <div class="col-lg-4">
                    <div class="mb-3">
                      <label for="stock" class="form-label">Total Stock</label>
                      <input type="text" name="stock" id="stock" class="form-control" value="<%= product.stock %>">
                    </div>
                  </div>
                  <div class="col-lg-4">
                    <div class="mb-3">
                      <label for="lowStockAlert" class="form-label">Low Stock Alert</label>
                      <input type="text" name="lowStockAlert" id="lowStockAlert" class="form-control" value="<%= product.lowStockLimit %>">
                    </div>
                  </div>
                </div>



                 <div class="row">
                  <div class="col-lg-4">
                    <div class="mb-3">
                      <label for="fabric" class="form-label">Fabric</label>
                      <input type="text" name="fabric" id="fabric" class="form-control" placeholder="fabric"  value="<%= product.fabric %>">
                    </div>
                  </div>
                  <div class="col-lg-4">
                    <div class="mb-3">
                      <label for="design" class="form-label">Design(if no,type nil)</label>
                      <input type="text" name="design" id="design" class="form-control" placeholder="design"  value="<%= product.design %>">
                    </div>
                  </div>
                  <div class="col-lg-4">
                    <div class="mb-3">
                      <label for="colour" class="form-label">Colour</label>
                      <input type="text" name="colour" id="colour" class="form-control" placeholder="colour"  value="<%= product.colour %>">
                    </div>
                  </div>
                </div>




                <div class="row">
                  <div class="col-lg-12">
                    <div class="mb-3">
                      <label for="description" class="form-label">Description</label>
                      <!-- <textarea class="form-control bg-light-subtle" name="description" id="description" rows="7"
                        placeholder="Short description about the product"  value="<%= product.description %>"> <%= product.description %></textarea> -->
                        <textarea class="form-control bg-light-subtle" name="description" id="description" rows="7"
  placeholder="Short description about the product"><%= product.description %></textarea>

                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <h4 class="card-title">Pricing Details</h4>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-lg-6">
                    <label for="price" class="form-label">Price</label>
                    <div class="input-group mb-3">
                      <span class="input-group-text fs-15">Rs: </span>
                      <input type="number" name="price" id="price" class="form-control" value="<%= product.price %>">
                    </div>
                  </div>

                  <div class="col-lg-6">
                    <label for="discount" class="form-label">Discount Price</label>
                    <div class="input-group mb-3">
                      <span class="input-group-text fs-20"><i class='bx bxs-discount'></i></span>
                      <input type="number" name="discount" id="discount" class="form-control" value="<%= product.discount %>">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="p-3 bg-light mb-3 rounded">
              <div class="row justify-content-end g-2">
                <div class="col-lg-2">
                  <button type="submit" class="btn btn-outline-secondary w-100">Edit Product</button>
                </div>
                <div class="col-lg-2">
                  <button type="reset" class="btn btn-primary w-100">Cancel</button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
               <!-- End Container Fluid -->
          <!-- ==================================================== -->
          <!-- End Page Content -->
          <!-- ==================================================== -->

 
 
 <%- include('./partials/footer') %>
  </div>
</div>

<!-- ‚úÖ FilePond Styles -->
<link href="https://unpkg.com/filepond@^4/dist/filepond.css" rel="stylesheet" />
<link href="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.css" rel="stylesheet" />

<!-- ‚úÖ FilePond Scripts -->
<script src="https://unpkg.com/filepond@^4/dist/filepond.js"></script>
<script src="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.js"></script>

<!-- <script>
  FilePond.registerPlugin(FilePondPluginImagePreview);

  const pond = FilePond.create(document.querySelector('.filepond'), {
    allowMultiple: true,
    maxFiles: 5,
    imagePreviewHeight: 170,
    acceptedFileTypes: ['image/png', 'image/jpeg', 'image/gif'],
    labelIdle: 'Drag & Drop your images or <span class="filepond--label-action">Browse</span>'
  });

    // üñºÔ∏è Preload existing images
  const existingImages = <%- JSON.stringify(product.images || []) %>;

  existingImages.forEach((image, index) => {
    pond.addFile(image).catch(err => {
      console.error('Error preloading image:', err);
    });
  });

   document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("CategoryForm");

    form.addEventListener("submit", function (e) {
      e.preventDefault();
      const formData = new FormData(form);

      // Add FilePond files
      pond.getFiles().forEach(fileItem => {
        formData.append("thumbnail[]", fileItem.file);
      });
     });
  });
      </script> -->
   
<!-- <script>
  FilePond.registerPlugin(FilePondPluginImagePreview);

  const pond = FilePond.create(document.querySelector('.filepond'), {
    allowMultiple: true,
    maxFiles: 5,
    imagePreviewHeight: 170,
    acceptedFileTypes: ['image/png', 'image/jpeg', 'image/gif'],
    labelIdle: 'Drag & Drop your images or <span class="filepond--label-action">Browse</span>'
  });

  // üñºÔ∏è Preload existing images
  const existingImages = <%- JSON.stringify(product.images.map(img => ({
    source: '/uploads/' + img,
    options: {
      type: 'local',
      file: {
        name: img,
        size: 123456, // placeholder size
        type: 'image/jpeg',
      }
    }
  }))) %>;
  pond.files = existingImages;

  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("editProductForm");

    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(form);

      // Append FilePond images
      pond.getFiles().forEach(fileItem => {
        formData.append("thumbnail[]", fileItem.file);
      });

      // üü° Dynamic URL
      const url = `/admin/edit-product?id=<%= product._id %>`;

      try {
        const response = await fetch(url, {
          method: "POST",
          body: formData,
        });

        const result = await response.json();

        if (response.ok) {
          alert("Product updated successfully!");
          window.location.href = "/admin/products";
        } else {
          alert(result.message || "Something went wrong.");
        }
      } catch (error) {
        console.error("Edit failed:", error);
        alert("An error occurred while submitting the form.");
      }
    });
  });
</script> -->



<script>
  FilePond.registerPlugin(FilePondPluginImagePreview);

  const pond = FilePond.create(document.querySelector('.filepond'), {
    allowMultiple: true,
    maxFiles: 5,
    imagePreviewHeight: 170,
    acceptedFileTypes: ['image/png', 'image/jpeg', 'image/gif'],
    labelIdle: 'Drag & Drop your images or <span class="filepond--label-action">Browse</span>'
  });

  const existingImages = <%- JSON.stringify(product.images.map(img => ({
    source: '/uploads/' + img,
    options: {
      type: 'local',
      file: {
        name: img,
        size: 123456,
        type: 'image/jpeg',
      }
    }
  }))) %>;
  pond.files = existingImages;

  window.addEventListener("load", () => {
    console.log("‚úÖ Script Loaded");

    const form = document.getElementById("editProductForm");
    if (!form) {
      console.error("‚ùå Form not found");
      return;
    }

    console.log("‚úÖ Form found");

    form.addEventListener("submit", async function (e) {
      e.preventDefault();
      console.log("‚úÖ Submit triggered");

      const formData = new FormData(form);

      pond.getFiles().forEach(fileItem => {
        formData.append("thumbnail[]", fileItem.file);
      });

      const url = `/admin/edit-product?id=<%= product._id %>`;

      try {
        const response = await fetch(url, {
          method: "POST",
          body: formData,
        });

        const result = await response.json();

        if (response.ok) {
          Swal.fire({
            icon: 'success',
            title: 'Success',
            text: 'Product updated successfully!',
            confirmButtonText: 'OK'
          }).then(() => {
            window.location.href = "/admin/list-product";
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: result.message || "Something went wrong.",
          });
        }
      } catch (error) {
        console.error("Edit failed:", error);
        Swal.fire({
          icon: 'error',
          title: 'Oops!',
          text: 'An error occurred while submitting the form.',
        });
      }
    });
  });
</script>


   <style>
  .filepond--item {
    width: calc(25% - 0.5em);
  }

  .filepond--list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5em;
  }
</style>

<%- include('./partials/header') %>

  <div class="wrapper">
    <%- include('./partials/adminHeader') %>
      <%- include('./partials/sidebar') %>

        <div class="page-content">
          <div class="container-fluid">

            <div class="row">
              <div class="col-xl-12">
                <div class="card">

                  <div class="card-header d-flex justify-content-between align-items-center gap-1">
                    <h4 class="card-title flex-grow-1">Review List</h4>

                    <a href="#" class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#exportModal">
                      Export
                    </a>

                  </div>

                  <div>
                    <div class="table-responsive">
                      <table class="table align-middle mb-0 table-hover table-centered">
                        <thead class="bg-light-subtle">
                          <tr>
                            <th>#</th>
                            <th>UserId</th>
                            <th>ProductId</th>
                            <th>Rating</th>
                            <th>Review</th>

                            <th>Action</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% if (reviews.length> 0) { %>
                            <% reviews.forEach((review, index)=> { %>
                              <tr data-created="<%= new Date(review.createdAt).toISOString() %>">
                                <td>
                                  <%= index + 1 %>
                                </td>
                                <td>
                                  <a href="/admin/user-details?id=<%= review.userId._id %>"><%= review.userId.userId %></a>
                                </td>
                                <td>
                                  <a href="/admin/product-details?id=<%= review.productId._id %>"><%= review.productId ? review.productId.productId : 'N/A' %></a>
                                </td>

                                <td>
                                  <%= review.rating %>
                                </td>
                                <td>
                                  <%= review.review %>
                                </td>

                                <td>

                                  <form action="/admin/delete-review/<%= review._id %>" method="POST"
                                    style="display:inline;">
                                    <button type="submit" class="btn btn-soft-danger btn-sm delete-btn"
                                      onclick="return confirm('Are you sure you want to delete this review?');">
                                      <iconify-icon icon="solar:trash-bin-minimalistic-2-broken"
                                        class="align-middle fs-18"></iconify-icon>
                                    </button>
                                  </form>

                                </td>
                              </tr>

                              <% }) %>
                                <% } else { %>
                                  <tr>
                                    <td colspan="8" class="text-center">No Reviews found</td>
                                  </tr>
                                  <% } %>
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <div class="card-footer border-top">
                    <nav aria-label="Page navigation example">
                      <ul class="pagination justify-content-end mb-0">
                        <% if (currentPage> 1) { %>
                          <li class="page-item">
                            <a class="page-link" href="?page=<%= currentPage - 1 %>">Previous</a>
                          </li>
                          <% } else { %>
                            <li class="page-item disabled">
                              <span class="page-link">Previous</span>
                            </li>
                            <% } %>

                              <% for (let i=1; i <=totalPages; i++) { %>
                                <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                                  <a class="page-link" href="?page=<%= i %>">
                                    <%= i %>
                                  </a>
                                </li>
                                <% } %>

                                  <% if (currentPage < totalPages) { %>
                                    <li class="page-item">
                                      <a class="page-link" href="?page=<%= currentPage + 1 %>">Next</a>
                                    </li>
                                    <% } else { %>
                                      <li class="page-item disabled">
                                        <span class="page-link">Next</span>
                                      </li>
                                      <% } %>
                      </ul>
                    </nav>
                  </div>

                </div>
              </div>

            </div>
          </div>
          <%- include('./partials/footer') %>
        </div>

  </div>


  <style>
    .content-area {
      margin-left: 250px;
      padding: 2rem;
      transition: margin-left 0.3s ease;
    }

    @media (max-width: 768px) {
      .content-area {
        margin-left: 0 !important;
        padding: 1rem;
      }
    }
  </style>

  <script>
  document.querySelectorAll('.delete-offer-btn').forEach(button => {
    button.addEventListener('click', async function () {
      const offerId = this.dataset.offerId;

      const result = await Swal.fire({
        title: 'Are you sure?',
        text: 'Do you really want to delete this offer?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete it!'
      });

      if (result.isConfirmed) {
        try {
          const response = await fetch(`/admin/delete-offer/${offerId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });

          if (response.ok) {
            this.closest('.offer-row').remove(); // Adjust selector as per layout
            Swal.fire('Deleted!', 'The offer has been deleted.', 'success');
          } else {
            Swal.fire('Failed!', 'Failed to delete offer.', 'error');
          }
        } catch (error) {
          console.error('Delete failed:', error);
          Swal.fire('Error', 'Something went wrong.', 'error');
        }
      }
    });
  });

  // Replace inline confirm inside form button (in EJS loop)
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', function (e) {
      e.preventDefault();
      const form = this.closest('form');

      Swal.fire({
        title: 'Are you sure?',
        text: 'You won\'t be able to revert this!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete it!'
      }).then((result) => {
        if (result.isConfirmed) {
          form.submit();
        }
      });
    });
  });
</script>


<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Select Date Range</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="dateRangeInput" class="form-control" placeholder="Select date range" />
        <div id="dateError" class="text-danger d-none mt-2">Please select a valid date range</div>
      </div>
      <div class="modal-footer">
          <button type="submit" class="btn btn-warning" onclick="downloadReviewPDF()">Download PDF</button>
        </div>
      </div>
  </div>
</div>

<script>
  let selectedStartDate = null;
  let selectedEndDate = null;

  flatpickr("#dateRangeInput", {
    mode: "range",
    dateFormat: "d/m/Y",
    onChange: function (selectedDates) {
      if (selectedDates.length === 2) {
        selectedStartDate = selectedDates[0];
        selectedEndDate = selectedDates[1];
        document.getElementById('dateError').classList.add('d-none');
      }
    }
  });

  async function downloadReviewPDF() {
    if (!selectedStartDate || !selectedEndDate || selectedEndDate < selectedStartDate) {
      Swal.fire({
        icon: 'warning',
        title: 'Invalid Date Range',
        text: 'Please select a valid start and end date.'
      });
      return;
    }

    const formattedStart = selectedStartDate.toISOString();
    const formattedEnd = selectedEndDate.toISOString();

    try {
      const response = await fetch("/admin/export-reviews-pdf", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          startDate: formattedStart,
          endDate: formattedEnd
        }),
      });

      // ❗ If no data, backend should return 404 or similar
      if (!response.ok) {
        const errorMsg = await response.text();
        Swal.fire({
          icon: 'warning',
          title: 'No Data Found',
          text: errorMsg || 'No reviews found for the selected date range.',
        });
        return;
      }

      // ✅ Download PDF
      const blob = await response.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `reviews_${selectedStartDate.toLocaleDateString()}-${selectedEndDate.toLocaleDateString()}.pdf`;
      document.body.appendChild(a);
      a.click();
      a.remove();

      // Cleanup & close modal
      document.getElementById("dateRangeInput").value = "";
      selectedStartDate = null;
      selectedEndDate = null;
      bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();

    } catch (err) {
      console.error(err);
      Swal.fire({
        icon: 'error',
        title: 'Export Failed',
        text: 'Something went wrong while generating the PDF.',
      });
    }
  }
</script>

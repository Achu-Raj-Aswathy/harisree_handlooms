<%- include ('./partials/header') %>
     <div class="wrapper">
          <%- include('./partials/adminHeader') %>
               <%- include('./partials/sidebar')%>

                    <!-- ==================================================== -->
                    <!-- Start right Content here -->
                    <!-- ==================================================== -->
                    <div class="page-content">

                         <!-- Start Container Fluid -->
                         <div class="container-fluid">

                              <div class="row">
                                   <div class="col-xl-12">
                                        <div class="card">
                                             <div
                                                  class="card-header d-flex justify-content-between align-items-center gap-1">
                                                  <h4 class="card-title flex-grow-1">All Product List</h4>

                                                  <a href="/admin/add-product" class="btn btn-sm btn-primary">
                                                       Add Product
                                                  </a>

                                                  <a href="#" class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#exportModal">Export</a>

                                             </div>
                                             
                                             <div>
                                                  <div class="table-responsive">
                                                       <table
                                                            class="table align-middle mb-0 table-hover table-centered">
                                                            <thead class="bg-light-subtle">
                                                                 <tr>

                                                                      <th>ID</th>
                                                                      <th>Name</th>
                                                                      <th>Category</th>
                                                                      <th>HSN Code</th>
                                                                      <th>SKU ID</th>

                                                                      <th>Price</th>
                                                                      <th>Action</th>
                                                                 </tr>
                                                            </thead>
                                                            <tbody>
                                                                 <% if(products.length>0){ %>
                                                                      <% products.forEach((product)=> { %>
                                                                           <tr data-created="<%= new Date(product.createdAt).toISOString() %>">
                                                                                <td>
                                                                                     <div
                                                                                          class="d-flex align-items-center gap-2">
                                                                                          <div
                                                                                               class="rounded bg-light avatar-md d-flex align-items-center justify-content-center">
                                                                                               <% if (product.images &&
                                                                                                    product.images.length>
                                                                                                    0) { %>

                                                                                                    <img src="<%= product.images[0] %>"
                                                                                                         alt="Product Image"
                                                                                                         class="avatar-md">
                                                                                                    <% } else { %>
                                                                                                         <img src="assets/images/handlooms/sarees27.jpg"
                                                                                                              alt="Category Image"
                                                                                                              class="avatar-md" />
                                                                                                         <% } %>
                                                                                          </div>
                                                                                          <div>
                                                                                               <a href="#!"
                                                                                                    class="text-dark fw-medium fs-15">
                                                                                                    <%= product.productId
                                                                                                         %>
                                                                                               </a>

                                                                                          </div>
                                                                                     </div>

                                                                                </td>
                                                                                <td>
                                                                                     <%= product.name %>
                                                                                </td>
                                                                                <td>
                                                                                     <%= product.categoryId.name %>
                                                                                </td>
                                                                                <td>
                                                                                     <%= product.hsnCode %>
                                                                                </td>
                                                                                <td>
                                                                                     <%= product.skuId %>
                                                                                </td>
                                                                                <td>
                                                                                     <%= product.price %>
                                                                                </td>
                                                                                <td>
                                                                                     <div class="d-flex gap-2">
                                                                                          <a href="/admin/product-details?id=<%= product._id %>"
                                                                                               class="btn btn-light btn-sm"><iconify-icon
                                                                                                    icon="solar:eye-broken"
                                                                                                    class="align-middle fs-18"></iconify-icon></a>
                                                                                          <a href="/admin/edit-product?id=<%= product._id %>"
                                                                                               class="btn btn-soft-primary btn-sm"><iconify-icon
                                                                                                    icon="solar:pen-2-broken"
                                                                                                    class="align-middle fs-18"></iconify-icon></a>
                                                                                          <a href="#!"
                                                                                               class="btn btn-soft-danger btn-sm delete-btn"
                                                                                               data-id="<%= product._id %>">
                                                                                               <iconify-icon
                                                                                                    icon="solar:trash-bin-minimalistic-2-broken"
                                                                                                    class="align-middle fs-18"></iconify-icon>
                                                                                          </a>

                                                                                     </div>
                                                                                </td>

                                                                           </tr>
                                                                           <% }) %>
                                                                                <% } else { %>
                                                                                     <tr>
                                                                                           <td colspan="7" class="text-center">No products found</td>
                                                                                     </tr>

                                                                                     <% } %>
                                                            </tbody>
                                                       </table>
                                                  </div>
                                                  <!-- end table-responsive -->
                                             </div>
                                            
                                             <div class="card-footer border-top">
  <nav aria-label="Page navigation example">
    <ul class="pagination justify-content-end mb-0">
      <% if (currentPage > 1) { %>
        <li class="page-item">
          <a class="page-link" href="?page=<%= currentPage - 1 %>">Previous</a>
        </li>
      <% } else { %>
        <li class="page-item disabled">
          <span class="page-link">Previous</span>
        </li>
      <% } %>

      <% for (let i = 1; i <= totalPages; i++) { %>
        <li class="page-item <%= currentPage === i ? 'active' : '' %>">
          <a class="page-link" href="?page=<%= i %>"><%= i %></a>
        </li>
      <% } %>

      <% if (currentPage < totalPages) { %>
        <li class="page-item">
          <a class="page-link" href="?page=<%= currentPage + 1 %>">Next</a>
        </li>
      <% } else { %>
        <li class="page-item disabled">
          <span class="page-link">Next</span>
        </li>
      <% } %>
    </ul>
  </nav>
                                             </div>

                                        </div>
                                   </div>

                              </div>

                         </div>
                         <!-- End Container Fluid -->

                         <%- include('./partials/footer') %>

                    </div>
                    <!-- ==================================================== -->
                    <!-- End Page Content -->
                    <!-- ==================================================== -->
     </div>

     <script>
          document.querySelectorAll('.delete-btn').forEach(button => {
               button.addEventListener('click', async function () {
                    const productId = this.getAttribute('data-id');

                    if (confirm('Are you sure you want to delete this product?')) {
                         try {
                              const res = await fetch(`/admin/delete-product/${productId}`, {
                                   method: 'DELETE',
                              });

                              if (res.ok) {
                                   alert('Product deleted successfully!');
                                   location.reload();
                              } else {
                                   const error = await res.json();
                                   alert('Failed to delete product: ' + error.message);
                              }
                         } catch (err) {
                              console.error(err);
                              alert('An error occurred while deleting.');
                         }
                    }
               });
          });
     </script>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Select Date Range</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="dateRangeInput" class="form-control" placeholder="Select date range" />
        <div id="dateError" class="text-danger d-none mt-2">Please select a valid date range</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-warning" onclick="downloadProductPDF()">Download PDF</button>
      </div>
    </div>
  </div>
</div>

<script>
  let selectedStartDate = null;
  let selectedEndDate = null;

  flatpickr("#dateRangeInput", {
    mode: "range",
    dateFormat: "d/m/Y",
    onChange: function (selectedDates) {
      if (selectedDates.length === 2) {
        selectedStartDate = selectedDates[0];
        selectedEndDate = selectedDates[1];
        document.getElementById('dateError').classList.add('d-none');
      }
    }
  });

  async function downloadProductPDF() {
    if (!selectedStartDate || !selectedEndDate || selectedEndDate < selectedStartDate) {
      document.getElementById('dateError').classList.remove('d-none');
      return;
    }

  const response = await fetch("/admin/export-products-pdf", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      startDate: selectedStartDate.toISOString(),
      endDate: selectedEndDate.toISOString(),
    }),
  });

  if (!response.ok) return alert("Failed to generate PDF");

  const blob = await response.blob();
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `products_${selectedStartDate.toLocaleDateString()}-${selectedEndDate.toLocaleDateString()}.pdf`;
  a.click();

  document.getElementById("dateRangeInput").value = "";
  selectedStartDate = null;
  selectedEndDate = null;
  bootstrap.Modal.getInstance(document.getElementById("exportModal")).hide();
  }
</script>
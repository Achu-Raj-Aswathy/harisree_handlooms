<%- include ('./partials/header') %>
     <div class="wrapper">
          <%- include('./partials/adminHeader') %>
               <%- include('./partials/sidebar')%>

                    <div class="page-content">

                         <!-- Start Container Fluid -->
                         <div class="container-xxl">

                              <!-- Start here.... -->

                              <div class="row">
                                   <div class="col-xl-12">
                                        <div class="card">
                                             <div class="d-flex card-header justify-content-between align-items-center">
                                                  <div>
                                                       <h4 class="card-title">All Warehouse List</h4>
                                                  </div>
                                                  <a href="#" class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#exportModal">
  Export
</a>
                                             </div>
                                             <div>
                                                  <div class="table-responsive">
                                                       <table
                                                            class="table align-middle mb-0 table-hover table-centered">
                                                            <thead class="bg-light-subtle">
                                                                 <tr>

                                                                      <th>Product ID</th>
                                                                      <th>Product Name</th>

                                                                      <th>Price</th>
                                                                      <th>Discount Price</th>
                                                                      <th>Stock</th>
                                                                      <th>Shipped Stock</th>
                                                                      <th>Stock Available </th>
                                                                      <th>Total Revenue</th>
                                                                      <!-- <th>Action</th> -->
                                                                 </tr>
                                                            </thead>
                                                            <tbody>
                                                                 <% if(products.length>0){ %>


                                                                      <% products.forEach((product)=> { %>
                                                                           <tr>

                                                                                <td>
                                                                                     <%= product.productId %>
                                                                                </td>
                                                                                <td>
                                                                                     <%= product.name %>
                                                                                </td>


                                                                                <td>
                                                                                     <%= product.price %>
                                                                                </td>
                                                                                <td>
                                                                                     <%= product.discount %>
                                                                                </td>
                                                                                <td>
                                                                                     <%= product.stock %>
                                                                                </td>

                                                                                <% let TotalStock=product.stock; let
                                                                                     availableStock=product.availableStock;
                                                                                     let
                                                                                     Shippedstock=TotalStock-availableStock;
                                                                                     let price=product.discount; let
                                                                                     TotalRevenue=Shippedstock*price; %>

                                                                                     <td>
                                                                                          <%= Shippedstock %>
                                                                                     </td>
                                                                                     <td>
                                                                                          <%= product.availableStock %>
                                                                                     </td>
                                                                                     <td>
                                                                                          <%= TotalRevenue %>
                                                                                     </td>
                                                                                     <td>
                                                                                          <!-- <div class="d-flex gap-2">
                                                                      <a href="#!" class="btn btn-light btn-sm"><iconify-icon icon="solar:eye-broken" class="align-middle fs-18"></iconify-icon></a>
                                                                      <a href="#!" class="btn btn-soft-primary btn-sm" data-bs-toggle="modal" data-bs-target="#staticBackdrop"><iconify-icon icon="solar:pen-2-broken" class="align-middle fs-18"></iconify-icon></a>
                                                                      <a href="#!" class="btn btn-soft-danger btn-sm"><iconify-icon icon="solar:trash-bin-minimalistic-2-broken" class="align-middle fs-18"></iconify-icon></a>
                                                                 </div> -->
                                                                                     </td>
                                                                           </tr>

                                                                           <% }) %>
                                                                                <% } else { %>
                                                                                     <tr>
                                                                                          <td colspan="7"
                                                                                               class="text-center">No
                                                                                               products found</td>
                                                                                     </tr>

                                                                                     <% } %>
                                                            </tbody>
                                                       </table>
                                                  </div>
                                                  <!-- end table-responsive -->
                                             </div>
                                             <div class="card-footer border-top">
                                                  <nav aria-label="Page navigation example">
                                                       <ul class="pagination justify-content-end mb-0">
                                                            <% if (currentPage> 1) { %>
                                                                 <li class="page-item">
                                                                      <a class="page-link"
                                                                           href="?page=<%= currentPage - 1 %>">Previous</a>
                                                                 </li>
                                                                 <% } else { %>
                                                                      <li class="page-item disabled">
                                                                           <span class="page-link">Previous</span>
                                                                      </li>
                                                                      <% } %>

                                                                           <% for (let i=1; i <=totalPages; i++) { %>
                                                                                <li
                                                                                     class="page-item <%= currentPage === i ? 'active' : '' %>">
                                                                                     <a class="page-link"
                                                                                          href="?page=<%= i %>">
                                                                                          <%= i %>
                                                                                     </a>
                                                                                </li>
                                                                                <% } %>

                                                                                     <% if (currentPage < totalPages) {
                                                                                          %>
                                                                                          <li class="page-item">
                                                                                               <a class="page-link"
                                                                                                    href="?page=<%= currentPage + 1 %>">Next</a>
                                                                                          </li>
                                                                                          <% } else { %>
                                                                                               <li
                                                                                                    class="page-item disabled">
                                                                                                    <span
                                                                                                         class="page-link">Next</span>
                                                                                               </li>
                                                                                               <% } %>
                                                       </ul>
                                                  </nav>
                                             </div>
                                        </div>
                                   </div>

                              </div>



                         </div>
                         <!-- End Container Fluid -->

                         <!-- ========== Footer Start ========== -->
                         <%- include('./partials/footer') %>
                              <!-- ========== Footer End ========== -->

                    </div>
                    <!-- ==================================================== -->
                    <!-- End Page Content -->
                    <!-- ==================================================== -->

     </div>

     <!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Select Date Range</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="reportDateRangeInput" class="form-control" placeholder="Select date range" />
        <div id="reportDateError" class="text-danger d-none mt-2">Please select a valid date range</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-warning" onclick="downloadReportPDF()">Download PDF</button>
      </div>
    </div>
  </div>
</div>

<script>
  let reportStartDate = null;
  let reportEndDate = null;

  flatpickr("#reportDateRangeInput", {
    mode: "range",
    dateFormat: "d/m/Y",
    onChange: function (selectedDates) {
      if (selectedDates.length === 2) {
        reportStartDate = selectedDates[0];
        reportEndDate = selectedDates[1];
        document.getElementById('reportDateError').classList.add('d-none');
      }
    }
  });

  async function downloadReportPDF() {
    if (!reportStartDate || !reportEndDate || reportEndDate < reportStartDate) {
      document.getElementById('reportDateError').classList.remove('d-none');
      return;
    }

    const formattedStart = reportStartDate.toISOString();
    const formattedEnd = reportEndDate.toISOString();

    const form = document.createElement("form");
    form.method = "POST";
    form.action = "/admin/export-report-pdf";
    form.style.display = "none";

    const startInput = document.createElement("input");
    startInput.name = "startDate";
    startInput.value = formattedStart;
    form.appendChild(startInput);

    const endInput = document.createElement("input");
    endInput.name = "endDate";
    endInput.value = formattedEnd;
    form.appendChild(endInput);

    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);

    // Reset UI
    document.getElementById("reportDateRangeInput").value = "";
    reportStartDate = null;
    reportEndDate = null;
    bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();
  }
</script>

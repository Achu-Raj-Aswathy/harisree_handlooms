<%- include('./partials/header') %>
<%- include('./partials/userHeader') %>

<main class="main-wrapper">
    <!-- Start Wishlist Area  -->
    <div class="axil-wishlist-area axil-section-gap">
        <div class="container">
            <div class="product-table-heading">
                <h4 class="title">My Wish List on Harisree Handlooms</h4>
            </div>
            <div class="table-responsive">
                <table class="table axil-product-table axil-wishlist-table">
                    <thead>
                        <tr>
                            <th scope="col" class="product-remove"></th>
                            <th scope="col" class="product-thumbnail">Product</th>
                            <th scope="col" class="product-title"></th>
                            <th scope="col" class="product-price">Unit Price</th>
                            <th scope="col" class="product-stock-status">Stock Status</th>
                            <th scope="col" class="product-add-cart"></th>
                        </tr>
                    </thead>
                    <tbody>
                      <% const validWishlists = wishlists.filter(item => item.productId); %>
<% if (validWishlists.length === 0) { %>
  <tr>
    <td colspan="6" class="text-center">Your wishlist is empty.</td>
  </tr>
<% } else { %>
  <% validWishlists.forEach(item => { %>
    <% const product = item.productId; %>
                            <% if (!product) return; // Prevent rendering null products
                        %>
                            <tr>
                                <td class="product-remove">
                                    <a href="#" class="remove-from-wishlist" data-id="<%= product._id %>">
                                        <i class="fal fa-times"></i>
                                    </a>
                                </td>
                                <td class="product-thumbnail">
                                    <a href="/product?id=<%= product._id %>">
                                        <img src="<%= product.images[0] %>" alt="<%= product.name %>" />
                                    </a>
                                </td>
                                <td class="product-title">
                                    <a href="/product?id=<%= product._id %>"><%= product.name %></a>
                                </td>
                                <td class="product-price" data-title="Price">
                                    â‚¹<%= product.discount || product.price %>
                                </td>
                                <td class="product-stock-status" data-title="Status">
                                    <%= product.isAvailable ? "In Stock" : "Out of Stock" %>
                                </td>
                                <td class="product-add-cart">
                                    <a href="#" data-id="<%= product._id %>" class="add-to-cart axil-btn btn-outline">Add to Cart</a>
                                </td>
                            </tr>
                        <% }) %>
                          <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- End Wishlist Area  -->
</main>

<%- include('./partials/footer') %>

<!-- SweetAlert2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".remove-from-wishlist").forEach((el) => {
      el.addEventListener("click", async function (e) {
        e.preventDefault();
        const productId = this.dataset.id;

        try {
          const res = await fetch(`/wishlist/remove?id=${productId}`, { method: "DELETE" });
          const data = await res.json();

          if (data.loginRequired) {
          Swal.fire({
            icon: "error",
            title: "Oops...",
            text: data.message || "Login Required",
            timer: 1500,
            showConfirmButton: false
          }).then(() =>  window.location.href = "/signin");
          
  return;
}
          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: 'Removed!',
              text: 'Product removed from wishlist.',
              confirmButtonColor: '#3085d6',
              confirmButtonText: 'OK'
            }).then(() => {
              window.location.reload();
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Oops!',
              text: data.message || 'Could not remove item.',
              confirmButtonColor: '#d33'
            });
          }
        } catch (err) {
          console.error("Error:", err);
          Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: 'Something went wrong.',
            confirmButtonColor: '#d33'
          });
        }
      });
    });
  });
</script>

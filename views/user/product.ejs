<%- include('./partials/header') %>
  <%- include('./partials/userHeader') %>
    <main class="main-wrapper">
      <!-- Start Shop Area  -->
      <div class="axil-single-product-area bg-color-white">
        <div class="single-product-thumb axil-section-gap pb--20 pb_sm--0 bg-vista-white">

          <div class="container">
            <div class="row row--25 align-items-start">
              <!-- üñºÔ∏è Image Slider - LEFT (Desktop) -->
              <div class="col-lg-5 mb--40">
                <div class="position-sticky sticky-top">
                  <div class="product-image-slider mb-4">

                    <!-- üñºÔ∏è Image Slider -->
                    <% if (product.images && product.images.length> 0) { %>
                      <% product.images.forEach(image=> { %>
                        <div style="display: flex; justify-content: center; align-items: center;">

                          <img class="img-fluid object-cover" src="<%= image %>" alt="<%= product.name %>"
                            style="border-radius: 10px; height: 400px; width: 300px; " />
                        </div>
                        <% }) %>
                          <% } else { %>
                            <div>
                              <img class="img-fluid w-100" src="/assets/images/placeholder.jpg" alt="No Image Available"
                                style="border-radius: 10px;" />
                            </div>
                            <% } %>

                  </div>
                </div>
              </div>

              <!-- üìù Product Info - RIGHT (Desktop) -->
              <div class="col-lg-7 mb--40">
                <div class="single-product-content">
                  <div class="inner">
                    <h2 class="product-title">
                      <%= product.name %>
                    </h2>
                    <span class="price-amount"><span style="text-decoration: line-through; color: grey">‚Çπ<%=
                          product.price %></span>&nbsp;‚Çπ<%= product.discount %></span>
                   <!-- ‚≠ê Overall Rating Display (Place this here) -->
    

                    <ul class="product-meta mb-3">
  <% if (product.isAvailable) { %>
    <li><i class="fal fa-check text-success"></i> In stock</li>
  <% } else { %>
    <li><i class="fal fa-times text-danger"></i> Out of stock</li>
  <% } %>
  <li><i class="fal fa-check"></i> Free delivery available</li>
</ul>

                    <p class="description mb-4">
                      <%= product.description %>
                    </p>

                    <h6>Product Details</h6>
                    <ul class="list-unstyled">
                      <li><span>Length: </span>
                        <%= product.length %>
                      </li>
                    <% if (product.blouseDetails && product.blouseDetails.toLowerCase() !== "nil") { %>
  <li>
    <span>Blouse Details: </span>
    <%= product.blouseDetails %>
  </li>
<% } %>


                    <li><span>Fabric: </span>
                        <%= product.fabric %>
                      </li>

                   <% if (product.design && product.design.toLowerCase() !== "nil") { %>
  <li>
    <span>Design: </span>
    <%= product.design %>
  </li>
<% } %>


                      <li><span>Colour: </span>
                        <%= product.colour %>
                      </li>
                    </ul>

<div class="product-action-wrapper mt-4">
  <div class="d-flex align-items-center gap-3 flex-wrap flex-lg-nowrap" style="flex-wrap: nowrap;">
    
    <!-- üì¶ Quantity Selector -->
    <div class="d-flex align-items-center border rounded-pill px-3 py-1 bg-light"
      style="height: 44px; white-space: nowrap;">
      <button class="btn btn-sm px-2 py-0 border-0 bg-transparent" onclick="adjustQty(-1)">
        <i class="fas fa-minus"></i>
      </button>
      <span id="qty-value" class="mx-3 fw-bold"
        style="min-width: 20px; text-align: center; font-size: 16px; color: #000;">1</span>
      <button class="btn btn-sm px-2 py-0 border-0 bg-transparent" onclick="adjustQty(1)">
        <i class="fas fa-plus"></i>
      </button>
    </div>

<!-- üõçÔ∏è Buy Now -->
<button
  type="button"
  class="btn btn-danger fw-semibold px-4 py-2 rounded-pill"
  style="height: 44px;"
  onclick="buyNow('<%= product._id %>', '<%= product.name %>', <%= product.discount || product.price %>)"
  <%= !product.isAvailable ? 'disabled' : '' %>>
  Buy Now
</button>


    <!-- ‚ù§Ô∏è Wishlist -->
    <button
      class="add-to-wishlist btn btn-outline-dark rounded-circle d-flex align-items-center justify-content-center"
      style="width: 55px; height: 44px;" data-id="<%=product._id %>">
      <i class="fas fa-heart text-danger"></i>
    </button>

    <!-- üõí Add to Cart -->
    <button data-id="<%= product._id %>"
      class="add-to-cart btn btn-outline-dark rounded-circle d-flex align-items-center justify-content-center"
      style="width: 55px; height: 44px;">
      <i class="fas fa-cart-plus"></i>
    </button>

  </div>
</div>


<form id="buyNowForm" action="/checkout" method="POST">
  <input type="hidden" name="cartData" id="productCartDataInput" />
</form>


                    <!-- üì¢ Customer Reviews -->
                    <!-- Review Form -->
                   <!-- ‚≠ê Submit Review Form -->
<form id="reviewForm" action="/product/<%= product._id %>/review" method="POST" enctype="multipart/form-data">
  <div class="form-group mt-5">
    <div class="row">
      <div class="rating-container col-6">
        <p>Rate Your Product:</p>
        <div id="overallRating-stars">
          <% for(let i = 1; i <= 5; i++) { %>
            <span class="star" onclick="setRating('overallRating', <%= i %>)">‚òÖ</span>
          <% } %>
        </div>
        <input type="hidden" id="overallRating" name="rating" required />
      </div>
      <div class="toggle-bar col-6">
        <a href="javascript:void(0)" class="toggle-btn-write">Write a Review..?</a>
      </div>
    </div>

    <div class="toggle-open-write">
      <div class="form-group mt-4">
        <p>Your Review</p>
        <textarea id="review" name="comment" class="form-control" rows="4" placeholder="Write your experience..."  required></textarea>
      </div>

      <div class="form-group">
        <p>Upload Images</p>
        <input type="file" name="images" class="form-control" multiple />
      </div>

      <ul class="list-inline mt-4">
        <li class="list-inline-item">
          <button type="submit" class="btn btn-success">Submit</button>
        </li>
        <li class="list-inline-item">
          <button type="reset" class="btn btn-danger">Cancel</button>
        </li>
      </ul>
    </div>
  </div>
</form>

                   <div class="form-group  mt-5">
                        <div class="row">
                          <div class="rating-container col-6">
                            <p>Overall Rating:</p>
                            <div class="d-flex">
  <% for (let i = 1; i <= 5; i++) { %>
    <i class="fa-star <%= i <= Math.round(avgRating) ? 'fas text-warning' : 'far text-muted' %>"></i>
  <% } %>
</div>

                            <!-- <div id="overallRating-stars">
                              <span class="star" onclick="setRating('overallRating', 1)">‚òÖ</span>
                              <span class="star" onclick="setRating('overallRating', 2)">‚òÖ</span>
                              <span class="star" onclick="setRating('overallRating', 3)">‚òÖ</span>
                              <span class="star" onclick="setRating('overallRating', 4)">‚òÖ</span>
                              <span class="star" onclick="setRating('overallRating', 5)">‚òÖ</span>
                            </div> -->
                            <input type="hidden" id="overallRating" name="overallRating" required />
                          </div>

                          <div class="toggle-bar col-6">
                            <a href="javascript:void(0)" class="toggle-btn-view">
                              View Reviews..!
                            </a>
                          </div>

                        </div>

                        <div class="toggle-open-view">

                          <!-- ‚≠ê View Reviews -->
<div class="form-group">
  <h4>Customer Reviews</h4>
  <% if (reviews && reviews.length > 0) { %>
  <% reviews.forEach(review => { %>
    <div class="border p-3 mb-3 rounded shadow-sm bg-light">
      <strong>‚≠ê <%= review.rating %>/5</strong>
      <p class="mb-1"><%= review.review %></p>
      <% if (review.images && review.images.length > 0) { %>
        <div class="d-flex gap-2 flex-wrap mt-2">
          <% review.images.forEach(img => { %>
            <img src="<%= img %>" alt="Review Image" style="height: 80px; width: auto; border-radius: 5px;" />
          <% }) %>
        </div>
      <% } %>
    </div>
  <% }) %>
<% } else { %>
  <p>No reviews yet. Be the first to review!</p>
<% } %>

</div>
                        </div>
                      </div>
                   <style>
  .rating-container {
    align-items: center;
    gap: 10px;
  }

  .rating-container p {
    margin: 0;
    font-weight: 500;
  }

  #overallRating-stars .star {
    font-size: 20px;
    color: #ccc;
    cursor: pointer;
    margin-left: 0px;
  }

  #overallRating-stars .star.selected {
    color: gold;
  }

  .toggle-open {
    display: none;
  }

  .toggle-open.show {
    display: block;
    animation: fadeIn 0.3s ease-in-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>


<style>
  .toggle-open-write,
  .toggle-open-view {
    display: none;
  }

  .toggle-open-write.show,
  .toggle-open-view.show {
    display: block;
    animation: fadeIn 0.3s ease-in-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .rating-container {
    align-items: center;
    gap: 10px;
  }

  .rating-container p {
    margin: 0;
    font-weight: 500;
  }

  #overallRating-stars .star {
    font-size: 20px;
    color: #ccc;
    cursor: pointer;
    margin-left: 5px;
  }

  #overallRating-stars .star.selected {
    color: gold;
  }
</style>

                </div>
              </div>
            </div>
          </div>

          <!-- End Shop Area  -->
  <% if (recentlyViewedProducts && recentlyViewedProducts.length > 0) { %>
  <div class="axil-new-arrivals-product-area fullwidth-container flash-sale-area section-gap-80-35">
    <div class="container ml--xxl-0">
      <div class="section-title-border slider-section-title">
        <h2 class="title">Recently Viewed üí•</h2>
      </div>
      <div class="recently-viwed-activation slick-layout-wrapper--15 axil-slick-angle angle-top-slide">
        <% recentlyViewedProducts.forEach(product => { %>
          <div class="slick-single-layout">
            <div class="axil-product product-style-eight">
              <div class="thumbnail">
                <a href="/product?id=<%= product._id %>">
                  <% if (product.images && product.images.length > 0) { %>
                    <img class="main-img" src="<%= product.images[0] %>" alt="<%= product.name || 'Product' %>">
                  <% } else { %>
                    <img class="main-img" src="/images/placeholder.png" alt="No image available">
                  <% } %>
                </a>
                <% if (product.discount > 0) { %>
                  <div class="label-block label-left">
                    <div class="product-badget sale">Sale</div>
                  </div>
                <% } %>
                <!-- <div class="product-hover-action">
                  <ul class="cart-action">
                    <li class="select-option">
                      <a href="/product/<%= product._id %>">
                        <i class="fas fa-shopping-cart"></i> Add to Cart
                      </a>
                    </li>
                  </ul>
                </div> -->
              </div>
              <div class="product-content">
                <div class="inner">
                  <h5 class="title">
                    <a href="/product/<%= product._id %>"><%= product.name || 'Untitled' %></a>
                  </h5>
                  <div class="product-price-variant">
                   
                      <span class="price current-price">‚Çπ<%= product.discount %></span>
                   
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% }); %>
      </div>
    </div>
  </div>
<% } else { %>
  <div class="container text-center py-5">
    <h4>No recently viewed products üòî</h4>
  </div>
<% } %>

    </main>

   <script>
  $('.recently-viwed-activation').slick({
    infinite: false,
    slidesToShow: 4,
    slidesToScroll: 1,
    arrows: true,
    responsive: [
      {
        breakpoint: 992,
        settings: { slidesToShow: 2 }
      },
      {
        breakpoint: 768,
        settings: { slidesToShow: 1 }
      }
    ]
  });
</script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>

    <script>
      $(document).ready(function () {
        $('.product-image-slider').slick({
          slidesToShow: 1,
          slidesToScroll: 1,
          arrows: true,
          dots: true,
          autoplay: true,
          autoplaySpeed: 3000,
          adaptiveHeight: true
        });
      });


    </script>

    <script>
      function adjustQty(change) {
        const qtySpan = document.getElementById("qty-value");
        let currentQty = parseInt(qtySpan.innerText);
        if (!isNaN(currentQty)) {
          const newQty = Math.max(1, currentQty + change);
          qtySpan.innerText = newQty;
        }
      }
    </script>

    <script>
      // ‚≠ê Toggle review form
      document.querySelector(".toggle-btn").addEventListener("click", function () {
        document.querySelector(".toggle-open").classList.toggle("show");
      });

      // ‚≠ê Star rating selection
      function setRating(fieldId, rating) {
        const starContainer = document.getElementById(fieldId + "-stars");
        const stars = starContainer.querySelectorAll(".star");

        stars.forEach((star, index) => {
          if (index < rating) {
            star.classList.add("selected");
          } else {
            star.classList.remove("selected");
          }
        });

        document.getElementById(fieldId).value = rating;
      }
    </script>

<script>
  // ‚≠ê Toggle "Write a Review"
  document.querySelector(".toggle-btn-write").addEventListener("click", function () {
    document.querySelector(".toggle-open-write").classList.toggle("show");
  });

  // ‚≠ê Toggle "View Reviews"
  document.querySelector(".toggle-btn-view").addEventListener("click", function () {
    document.querySelector(".toggle-open-view").classList.toggle("show");
  });

  // ‚≠ê Star rating selection
  function setRating(fieldId, rating) {
    const starContainer = document.getElementById(fieldId + "-stars");
    const stars = starContainer.querySelectorAll(".star");

    stars.forEach((star, index) => {
      if (index < rating) {
        star.classList.add("selected");
      } else {
        star.classList.remove("selected");
      }
    });

    document.getElementById(fieldId).value = rating;
  }
</script>

<script>
  function buyNow(productId, name, price) {
    const qty = parseInt(document.getElementById("qty-value").innerText) || 1;
    const subtotal = (price * qty).toFixed(2);

    const cartSummary = {
      items: [
        {
          productId,
          name,
          quantity: qty,
          price: price,
          subtotal: subtotal
        }
      ],
      total: subtotal
    };

    const cartDataInput = document.getElementById("productCartDataInput");
    cartDataInput.value = JSON.stringify(cartSummary);

    document.getElementById("buyNowForm").submit();
  }
</script>

<% if (reviewAdded) { %>
<script>
  Swal.fire({
    icon: 'success',
    title: 'Thank you!',
    text: 'Your review has been added successfully.',
    timer: 2000,
    showConfirmButton: false
  });
</script>
<% } %>

    <%- include('./partials/footer') %>
      </div>                  